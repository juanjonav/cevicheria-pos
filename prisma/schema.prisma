// ============================================
// SCHEMA PARA POS CEVICHER√çA MVP
// ============================================

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum order_status {
  draft
  placed
  in_progress
  ready
  completed
  cancelled
}

enum payment_method {
  cash
  card
  yape
  plin
  transfer
  multiple
}

enum stock_movement_type {
  in          // Compra de insumos
  out         // Venta/consumo por receta
  adjustment  // Ajuste manual
  waste       // Merma
}

enum expense_category {
  supplies      // Insumos
  staff         // Personal
  services      // Servicios b√°sicos
  maintenance   // Mantenimiento
  transport     // Delivery
  marketing     // Publicidad
  taxes         // Impuestos
  other         // Otros
}

enum voucher_type {
  ticket
  invoice
  note
}

enum cash_register_status {
  open
  closed
}

// ============================================
// USUARIOS Y ROLES
// ============================================

model users {
  id              Int       @id @default(autoincrement())
  username        String    @unique
  email           String?   @unique
  full_name       String?
  password_hash   String
  role            String    @default("cashier")
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  orders          orders[]
  expenses        expenses[]
  payments        payments[]
  stock_movements stock_movements[]
  cash_registers  cash_registers[]

  @@index([username])
  @@index([role])
}

// ============================================
// CLIENTES
// ============================================

model clients {
  id              Int       @id @default(autoincrement())
  name            String
  phone           String?
  email           String?
  document_type   String?
  document_number String?   @unique
  address         String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  orders          orders[]

  @@index([document_number])
  @@index([phone])
}

// ============================================
// PROVEEDORES
// ============================================

model suppliers {
  id              Int       @id @default(autoincrement())
  name            String
  contact_name    String?
  phone           String?
  email           String?
  ruc             String?   @unique
  address         String?
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  expenses        expenses[]
  stock_movements stock_movements[]

  @@index([ruc])
}

// ============================================
// MEN√ö Y PRODUCTOS
// ============================================

model menu_categories {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  sort_order  Int          @default(0)
  is_active   Boolean      @default(true)
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt

  menu_items  menu_items[]
}

model menu_items {
  id              Int              @id @default(autoincrement())
  name            String
  description     String?
  category_id     Int
  price           Decimal          @db.Decimal(10, 2)
  cost            Decimal          @default(0) @db.Decimal(10, 2) // Costo calculado de receta
  is_available    Boolean          @default(true)
  image_url       String?
  preparation_time Int?
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  category        menu_categories  @relation(fields: [category_id], references: [id], onDelete: Restrict)
  order_lines     order_lines[]
  recipe_items    recipe_items[]   // üëà Receta del plato

  @@index([category_id])
  @@index([is_available])
}

// ============================================
// RECETAS (CLAVE PARA INVENTARIO AUTOM√ÅTICO)
// ============================================

model recipe_items {
  id            Int         @id @default(autoincrement())
  menu_item_id  Int
  stock_item_id Int
  quantity      Decimal     @db.Decimal(10, 3) // üëà Gramos/unidades necesarias
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt

  menu_item     menu_items  @relation(fields: [menu_item_id], references: [id], onDelete: Cascade)
  stock_item    stock_items @relation(fields: [stock_item_id], references: [id], onDelete: Restrict)

  @@unique([menu_item_id, stock_item_id])
  @@index([menu_item_id])
  @@index([stock_item_id])
}

// ============================================
// INVENTARIO (ALMAC√âN)
// ============================================

model stock_items {
  id              Int               @id @default(autoincrement())
  name            String
  unit            String            // kg, g, unidad, litro
  quantity        Decimal           @default(0) @db.Decimal(10, 3)
  min_alert_level Decimal           @default(0) @db.Decimal(10, 3) // üëà Stock m√≠nimo
  unit_cost       Decimal           @default(0) @db.Decimal(10, 2)
  is_active       Boolean           @default(true)
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  recipe_items    recipe_items[]
  stock_movements stock_movements[]

  @@index([quantity])
}

model stock_movements {
  id               Int                 @id @default(autoincrement())
  stock_item_id    Int
  movement_type    stock_movement_type
  quantity         Decimal             @db.Decimal(10, 3)
  unit_cost        Decimal?            @db.Decimal(10, 2)
  total_cost       Decimal?            @db.Decimal(10, 2)
  related_order_id Int?
  related_expense_id Int?
  supplier_id      Int?
  notes            String?
  movement_date    DateTime            @default(now())
  created_by       Int
  created_at       DateTime            @default(now())

  stock_item       stock_items         @relation(fields: [stock_item_id], references: [id], onDelete: Restrict)
  order            orders?             @relation(fields: [related_order_id], references: [id], onDelete: SetNull)
  expense          expenses?           @relation(fields: [related_expense_id], references: [id], onDelete: SetNull)
  supplier         suppliers?          @relation(fields: [supplier_id], references: [id], onDelete: SetNull)
  user             users               @relation(fields: [created_by], references: [id], onDelete: Restrict)

  @@index([stock_item_id])
  @@index([movement_date])
  @@index([movement_type])
}

// ============================================
// √ìRDENES Y VENTAS
// ============================================

model orders {
  id              Int           @id @default(autoincrement())
  order_number    String        @unique @default(cuid())
  client_id       Int?
  table_number    String?
  order_type      String        @default("salon")
  status          order_status  @default(draft)
  subtotal        Decimal       @default(0) @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @default(0) @db.Decimal(10, 2)
  voucher_type    voucher_type?
  voucher_number  String?
  notes           String?
  order_date      DateTime      @default(now())
  created_by      Int
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  client          clients?          @relation(fields: [client_id], references: [id], onDelete: SetNull)
  user            users             @relation(fields: [created_by], references: [id], onDelete: Restrict)
  order_lines     order_lines[]
  payments        payments[]
  stock_movements stock_movements[] // üëà Descuentos autom√°ticos

  @@index([order_date])
  @@index([status])
  @@index([order_number])
}

model order_lines {
  id            Int        @id @default(autoincrement())
  order_id      Int
  menu_item_id  Int
  quantity      Int
  price_at_sale Decimal    @db.Decimal(10, 2)
  discount      Decimal    @default(0) @db.Decimal(10, 2)
  line_total    Decimal    @db.Decimal(10, 2)
  notes         String?
  created_at    DateTime   @default(now())

  order         orders     @relation(fields: [order_id], references: [id], onDelete: Cascade)
  menu_item     menu_items @relation(fields: [menu_item_id], references: [id], onDelete: Restrict)

  @@index([order_id])
  @@index([menu_item_id])
}

// ============================================
// PAGOS
// ============================================

model payments {
  id            Int            @id @default(autoincrement())
  order_id      Int?
  expense_id    Int?
  method        payment_method
  amount        Decimal        @db.Decimal(10, 2)
  reference     String?
  notes         String?
  payment_date  DateTime       @default(now())
  created_by    Int
  created_at    DateTime       @default(now())

  order         orders?        @relation(fields: [order_id], references: [id], onDelete: Cascade)
  expense       expenses?      @relation(fields: [expense_id], references: [id], onDelete: Cascade)
  user          users          @relation(fields: [created_by], references: [id], onDelete: Restrict)

  @@index([payment_date])
  @@index([method])
}

// ============================================
// GASTOS OPERATIVOS
// ============================================

model expenses {
  id                Int               @id @default(autoincrement())
  category          expense_category
  supplier_id       Int?
  amount            Decimal           @db.Decimal(10, 2)
  tax               Decimal           @default(0) @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  description       String
  receipt_reference String?
  is_paid           Boolean           @default(false)
  is_fixed          Boolean           @default(false) // üëà NUEVO: Fijo vs Variable
  expense_date      DateTime          @default(now())
  created_by        Int
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  supplier          suppliers?        @relation(fields: [supplier_id], references: [id], onDelete: SetNull)
  user              users             @relation(fields: [created_by], references: [id], onDelete: Restrict)
  payments          payments[]
  stock_movements   stock_movements[]

  @@index([expense_date])
  @@index([category])
  @@index([is_paid])
  @@index([is_fixed]) // üëà NUEVO
}

// ============================================
// CAJA REGISTRADORA
// ============================================

model cash_registers {
  id              Int                   @id @default(autoincrement())
  user_id         Int
  status          cash_register_status
  opening_amount  Decimal               @db.Decimal(10, 2)
  closing_amount  Decimal?              @db.Decimal(10, 2)
  expected_amount Decimal?              @db.Decimal(10, 2)
  difference      Decimal?              @db.Decimal(10, 2)
  notes           String?
  opened_at       DateTime              @default(now())
  closed_at       DateTime?
  created_at      DateTime              @default(now())

  user            users                 @relation(fields: [user_id], references: [id], onDelete: Restrict)

  @@index([user_id])
  @@index([opened_at])
  @@index([status])
}